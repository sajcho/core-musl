# Description:	the musl c library (libc) implementation
# URL:		https://musl.libc.org/
# Maintainer:	sajcho, saux dot aarch64 at gmail dot com

name=musl
version=1.2.5
release=1
source=(https://musl.libc.org/releases/${name}-${version}.tar.gz \
	handle-aux-at_base.patch \
	__stack_chk_fail_local.c \
	getconf.c \
	getent.c \
	iconv.c)

build() {
	cd ${name}-${version}

	echo "${version} (build by SAUX-x86_64)" > VERSION

	patch -p1 -i $SRC/handle-aux-at_base.patch

	CFLAGS+=" -fPIE"

	./configure \
		--build=$CHOST \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc

	make V=1

	make prefix=/usr DESTDIR=$PKG install-headers

	make DESTDIR=$PKG install

	# create libssp_nonshared.a
	#/usr/bin/cc $CFLAGS -fpie -c $SRC/__stack_chk_fail_local.c \
	#	-o __stack_chk_fail_local.o
	#/usr/bin/ar r libssp_nonshared.a __stack_chk_fail_local.o
	#install -D -m 0644 libssp_nonshared.a -t $PKG/usr/lib

	# create getconf, getent, iconv
	local i
	for i in getconf getent iconv ; do
		/usr/bin/cc $CFLAGS $SRC/$i.c -o $i
	done

	install -D -m 0755 ./{getconf,getent,iconv} -t $PKG/usr/bin

	# create ldd
        cat >>$PKG/usr/bin/ldd <<-EOF
#!/bin/sh
exec /usr/lib/libc.so --list "\$@"
EOF
	chmod 0755 $PKG/usr/bin/ldd

	# create file for the dynamic linker path
	install -d $PKG/etc
	cat >>$PKG/etc/ld-musl-x86_64.path <<-EOF
#
# If you want to add your library in a non-standard path, add your own path.
#
/lib
/usr/lib
/usr/lib/gcc/x86_64-unknown-linux-musl/14.1.0
EOF
	chmod 0644 $PKG/etc/ld-musl-x86_64.path

	# create ldconfig file
	install -d $PKG/sbin
	cat >>$PKG/sbin/ldconfig <<-EOF
#!/bin/sh
/bin/true
EOF
	chmod 0755 $PKG/sbin/ldconfig

	# this file requires revdep
	echo "# this file requires 'revdep'" > $PKG/etc/ld.so.conf
}
